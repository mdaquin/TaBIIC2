{% extends "base.html" %}
{% set active_tab = "taxonomy" %}

{% block content %}
<div class="container taxonomy-container">
    {% if not loaded %}
    <div class="upload-section">
        <h2>Taxonomy</h2>
        <p class="text-muted">Upload a data file on the
           <a href="{{ url_for('data_tab') }}">Data tab</a> to begin building a taxonomy.</p>
    </div>

    {% else %}
    <div class="taxonomy-toolbar">
        <h2>Taxonomy</h2>
        <div class="toolbar-actions">
            <button class="btn btn-primary" id="btn-add-subconcept" disabled>Add Subconcept</button>
            <button class="btn btn-primary" id="btn-find-subconcepts" disabled>Find Sub-concepts</button>
            <button class="btn btn-secondary" id="btn-complement" disabled>Complement</button>
            <button class="btn btn-secondary" id="btn-union" disabled>Union</button>
            <button class="btn btn-secondary" id="btn-intersection" disabled>Intersection</button>
            <button class="btn btn-secondary" id="btn-find-intersections" disabled>Find Intersections</button>
            <button class="btn btn-secondary" id="btn-merge" disabled>Merge</button>
            <button class="btn btn-secondary" id="btn-delete" disabled>Delete</button>
            <button class="btn btn-secondary" id="btn-reset-taxonomy">Reset</button>
        </div>
    </div>

    <!-- WSOM Validation Bar -->
    <div class="wsom-validation-bar" id="wsom-validation-bar" hidden>
        <span>Proposed sub-concepts shown. Review and choose:</span>
        <div class="wsom-validation-actions">
            <button class="btn btn-primary" id="btn-wsom-validate">Validate</button>
            <button class="btn btn-secondary" id="btn-wsom-retry">Retry</button>
            <button class="btn btn-secondary" id="btn-wsom-cancel">Cancel</button>
        </div>
    </div>

    <div class="taxonomy-layout">
        <div class="taxonomy-graph-panel">
            <div id="cy" class="cytoscape-container"></div>
        </div>
        <div class="taxonomy-detail-panel" id="detail-panel">
            <div class="detail-placeholder">
                <p class="text-muted">Select a concept to view details</p>
            </div>
        </div>
    </div>

    <!-- Modal: Add Subconcept -->
    <div class="modal-overlay" id="modal-add-subconcept" hidden>
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Add Subconcept</h3>
                <button class="modal-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name (optional):</label>
                    <input type="text" id="subconcept-name" class="form-input" placeholder="Concept name">
                </div>
                <div id="restrictions-builder"></div>
                <button class="btn btn-secondary btn-sm" id="btn-add-restriction-row">+ Add Restriction</button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btn-confirm-subconcept">Create</button>
            </div>
        </div>
    </div>
    <!-- Modal: WSOM Hyperparameters -->
    <div class="modal-overlay" id="modal-wsom-params" hidden>
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Find Sub-concepts (WSOM)</h3>
                <button class="modal-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Columns to ignore:</label>
                    <div id="wsom-ignore-columns" class="wsom-column-checkboxes">
                        <span class="text-muted">Loading columns...</span>
                    </div>
                    <small class="text-muted">Checked columns are excluded from training and characterisation</small>
                </div>
                <div class="form-group">
                    <label>Map size (square grid):</label>
                    <input type="number" id="wsom-map-size" class="form-input" value="5" min="2" max="20" step="1">
                    <small class="text-muted">N &times; N grid of neurons (2&ndash;20)</small>
                </div>
                <div class="form-group">
                    <label>Column specificity:</label>
                    <input type="number" id="wsom-sparcity" class="form-input" value="0.01" min="0" max="1" step="0.001">
                    <small class="text-muted">Higher = fewer columns used (sparsity coefficient)</small>
                </div>
                <div class="form-group">
                    <label>Number of iterations:</label>
                    <input type="number" id="wsom-epochs" class="form-input" value="100" min="1" max="5000" step="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btn-start-wsom">Start Training</button>
            </div>
        </div>
    </div>

    <!-- WSOM Training Progress -->
    <div class="wsom-progress-overlay" id="wsom-progress-overlay" hidden>
        <div class="wsom-progress-card">
            <h3>Training WSOM...</h3>
            <div class="wsom-progress-bar-container">
                <div class="wsom-progress-bar" id="wsom-progress-bar" style="width: 0%"></div>
            </div>
            <p id="wsom-progress-text">Epoch 0 / 0</p>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if loaded %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
<script src="{{ url_for('static', filename='js/taxonomy_tab.js') }}"></script>
{% endif %}
{% endblock %}
